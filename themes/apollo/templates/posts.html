{% extends "base.html" %}

{% block main_content %}
    {% if section.extra.section_path -%}
        {% set section = get_section(path=section.extra.section_path) %}
    {% endif -%}

    {% block title %}
        {{ post_macros::page_header(title=section.title) }}
    {% endblock title %}
    <!-- Search bar -->
    <div class="search-bar">
        <input class="search" type="text" name="q" placeholder="Search..." value="" />
        <script>
            document.querySelector('.search-bar input').addEventListener('input', function(e) {
                var query = e.target.value;
                var posts = document.querySelectorAll('.list-item');
                posts.forEach(function(post) {
                    var title = post.querySelector('.title').textContent;
                    if (title.toLowerCase().includes(query.toLowerCase())) {
                        post.style.display = 'block';
                    } else {
                        post.style.display = 'none';
                    }
                });
            });
        </script>
    </div>
    <!-- Language -->
    <div class="language">
        <button class="language-button en" id="lb-en" onclick="toggleLanguage('en')" id="en">EN</button>
        <button class="language-button tr" id="lb-tr" onclick="toggleLanguage('tr')" id="tr">TR</button>

        <script>
            function setLangVisibility(lang, visible) {
                var posts = document.querySelectorAll('.list-item.' + lang);
                posts.forEach(function(post) { post.style.display = visible ? 'block' : 'none'; });
                var btn = document.getElementById('lb-' + lang);
                if (btn) btn.classList.toggle('inactive', !visible);
            }

            function getActiveLangs() {
                return ['en', 'tr'].filter(function(lang) {
                    var btn = document.getElementById('lb-' + lang);
                    return btn && !btn.classList.contains('inactive');
                });
            }

            function syncLangToUrl() {
                try {
                    var url = new URL(window.location.href);
                    var active = getActiveLangs();
                    if (active.length === 1) {
                        url.searchParams.set('lang', active[0]);
                    } else {
                        url.searchParams.delete('lang');
                    }
                    history.replaceState({}, '', url.toString());
                } catch (_e) {
                    // no-op
                }
            }

            function toggleLanguage(lang) {
                var btn = document.getElementById('lb-' + lang);
                if (!btn) return;

                // Toggle current language visibility
                var becomingActive = btn.classList.contains('inactive');
                setLangVisibility(lang, becomingActive);

                // Don't allow both languages to be hidden
                var active = getActiveLangs();
                if (active.length === 0) {
                    setLangVisibility(lang, true);
                    return;
                }

                syncLangToUrl();
            }

            // Auto-select language from URL: /posts?lang=en|tr (or #en/#tr)
            function initLanguageFromUrl() {
                try {
                    var params = new URLSearchParams(window.location.search);
                    var lang = (params.get('lang') || '').toLowerCase();
                    if (!lang) {
                        var hash = (window.location.hash || '').replace('#', '').toLowerCase();
                        lang = hash;
                    }
                    if (lang !== 'en' && lang !== 'tr') return;

                    // Hide all languages first (both start visible by default)
                    setLangVisibility('en', false);
                    setLangVisibility('tr', false);
                    setLangVisibility(lang, true);

                    syncLangToUrl();
                } catch (_e) {
                    // no-op
                }
            }

            // Run after the post list is present in the DOM
            document.addEventListener('DOMContentLoaded', initLanguageFromUrl);
        </script>
    </div>


    {% block post_list %}
        <main class="list">
            {%- if paginator %}
                {%- set show_pages = paginator.pages -%}
            {% else %}
                {%- set show_pages = section.pages -%}
            {% endif -%}

            {{ post_macros::list_posts(pages=show_pages) }}
        </main>
    {% endblock post_list %}

    {% if paginator %}
        <ul class="pagination">
            {% if paginator.previous %}
                <span class="page-item page-prev">
                    <a href={{ paginator.previous }} class="page-link" aria-label="Previous"><span aria-hidden="true">← Prev</span></a>
                </span>
            {% endif %}

            {% if paginator.next %}
                <span class="page-item page-next">
                    <a href={{ paginator.next }} class="page-link" aria-label="Next"><span aria-hidden="true">Next →</span></a>
                </span>
            {% endif %}
        </ul>
    {% endif %}
{% endblock main_content %}